import { useState, useEffect } from 'react';

const Icon = ({ name, className = "w-5 h-5" }) => {
    const icons = {
        printer: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
        plus: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        trash: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        calendar: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        save: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
        mail: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
        edit: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        phone: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>,
        download: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
        whatsapp: <svg className={className} fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    };
    return icons[name] || null;
};

export default function DentalBillingSystem() {
    const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
    const [invoiceNumber, setInvoiceNumber] = useState('');
    const [patientName, setPatientName] = useState('');
    const [patientAge, setPatientAge] = useState('');
    const [patientPhone, setPatientPhone] = useState('');
    const [patientEmail, setPatientEmail] = useState('');
    const [patientLocation, setPatientLocation] = useState('');
    const [clinicalAssessment, setClinicalAssessment] = useState('');
    const [doctorName, setDoctorName] = useState('');
    const [otherDoctorName, setOtherDoctorName] = useState('');
    const [showOtherDoctor, setShowOtherDoctor] = useState(false);
    const [treatments, setTreatments] = useState([]);
    const [currentTreatment, setCurrentTreatment] = useState('');
    const [customDescription, setCustomDescription] = useState('');
    const [treatmentPlan, setTreatmentPlan] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [discount, setDiscount] = useState('0');
    const [tax, setTax] = useState('18');
    const [paymentType, setPaymentType] = useState('');
    const [customPayment, setCustomPayment] = useState({
        mode1: 'Cash',
        amount1: '',
        mode2: 'UPI',
        amount2: ''
    });
    const [emiMonths, setEmiMonths] = useState('');
    const [downPayment, setDownPayment] = useState('');
    const [processingFee, setProcessingFee] = useState('0');
    const [emiTransactionId, setEmiTransactionId] = useState('');
    const [editingTreatment, setEditingTreatment] = useState(null);
    const [editValues, setEditValues] = useState({ name: '', price: '', plan: '' });
    const [saveStatus, setSaveStatus] = useState('');
    const [showCustomInput, setShowCustomInput] = useState(false);

    const commonTreatments = [
        'Root Canal Treatment',
        'Teeth Cleaning/Scaling',
        'Tooth Extraction',
        'Dental Filling',
        'Crown/Cap',
        'Bridge',
        'Dental Implant',
        'Teeth Whitening',
        'Orthodontic Braces',
        'Dentures',
        'Wisdom Tooth Removal',
        'Gum Treatment',
        'Veneer',
        'Consultation Fee',
        'Custom - Describe Service'
    ];

    const paymentTypes = ['UPI', 'Credit or Debit Card', 'Cash', 'EMI (Through SaveIn)', 'Custom (Multiple Modes)'];
    const paymentModes = ['Cash', 'Credit Card', 'Debit Card', 'UPI', 'Bank Transfer'];

    useEffect(() => {
        const date = new Date(invoiceDate);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const invoiceCount = Math.floor(Math.random() * 1000) + 1;
        setInvoiceNumber(`ADC-${year}-${month}-${String(invoiceCount).padStart(4, '0')}`);
    }, [invoiceDate]);

    const handleTreatmentSelect = (value) => {
        if (value === 'Custom - Describe Service') {
            setShowCustomInput(true);
            setCurrentTreatment('');
        } else {
            setShowCustomInput(false);
            setCurrentTreatment(value);
            setCustomDescription('');
        }
    };

    const addTreatment = () => {
        const treatmentName = showCustomInput ? customDescription : currentTreatment;
        if (treatmentName && currentPrice) {
            setTreatments([...treatments, {
                id: Date.now(),
                name: treatmentName,
                price: parseFloat(currentPrice),
                plan: treatmentPlan
            }]);
            setCurrentTreatment('');
            setCustomDescription('');
            setTreatmentPlan('');
            setCurrentPrice('');
            setShowCustomInput(false);
        }
    };

    const startEdit = (treatment) => {
        setEditingTreatment(treatment.id);
        setEditValues({ name: treatment.name, price: treatment.price.toString(), plan: treatment.plan || '' });
    };

    const saveEdit = (id) => {
        if (editValues.name && editValues.price) {
            setTreatments(treatments.map(t => 
                t.id === id ? { ...t, name: editValues.name, price: parseFloat(editValues.price), plan: editValues.plan } : t
            ));
            setEditingTreatment(null);
        }
    };

    const cancelEdit = () => {
        setEditingTreatment(null);
        setEditValues({ name: '', price: '', plan: '' });
    };

    const removeTreatment = (id) => {
        setTreatments(treatments.filter(t => t.id !== id));
    };

    const calculateSubtotal = () => {
        return treatments.reduce((sum, treatment) => sum + treatment.price, 0);
    };

    const calculateDiscount = () => {
        return (calculateSubtotal() * parseFloat(discount || 0)) / 100;
    };

    const calculateTax = () => {
        const afterDiscount = calculateSubtotal() - calculateDiscount();
        return (afterDiscount * parseFloat(tax || 0)) / 100;
    };

    const calculateTotal = () => {
        return calculateSubtotal() - calculateDiscount() + calculateTax();
    };

    const calculateEMIAmount = () => {
        if (paymentType !== 'EMI (Through SaveIn)' || !emiMonths) return 0;
        const remainingAmount = calculateTotal() - parseFloat(downPayment || 0) + parseFloat(processingFee || 0);
        return remainingAmount / parseFloat(emiMonths);
    };

    const handleDoctorChange = (value) => {
        if (value === 'Others') {
            setShowOtherDoctor(true);
            setDoctorName('');
        } else {
            setShowOtherDoctor(false);
            setDoctorName(value);
            setOtherDoctorName('');
        }
    };

    const handlePrint = () => {
        window.print();
    };

    const clearForm = () => {
        setPatientName('');
        setPatientAge('');
        setPatientPhone('');
        setPatientEmail('');
        setPatientLocation('');
        setClinicalAssessment('');
        setDoctorName('');
        setOtherDoctorName('');
        setShowOtherDoctor(false);
        setTreatments([]);
        setCurrentTreatment('');
        setCustomDescription('');
        setTreatmentPlan('');
        setCurrentPrice('');
        setDiscount('0');
        setTax('18');
        setPaymentType('');
        setCustomPayment({ mode1: 'Cash', amount1: '', mode2: 'UPI', amount2: '' });
        setEmiMonths('');
        setDownPayment('');
        setProcessingFee('0');
        setEmiTransactionId('');
        setShowCustomInput(false);
        setInvoiceDate(new Date().toISOString().split('T')[0]);
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50 p-2 md:p-4">
            <style>{`
                @media print {
                    body { background: white; margin: 0; padding: 0; }
                    @page { margin: 1cm; size: A4; }
                    .no-print { display: none !important; }
                    .watermark { opacity: 0.08 !important; }
                }
                .watermark {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    opacity: 0.05;
                    pointer-events: none;
                    z-index: 0;
                }
                .watermark img {
                    width: 350px;
                    height: auto;
                }
                .content-wrapper {
                    position: relative;
                    z-index: 1;
                }
            `}</style>

            <div className="max-w-5xl mx-auto">
                <div className="watermark">
                    <img 
                        src="https://raw.githubusercontent.com/ardradental/Bill/main/logo.png"
                        alt="Watermark"
                        onError={(e) => { e.target.style.display = 'none'; }}
                    />
                </div>

                <div className="content-wrapper">
                    <div className="bg-gradient-to-r from-white to-gray-50 rounded-lg shadow-xl p-6 mb-4 border-2 border-purple-200">
                        <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                            <div className="flex items-start gap-4 flex-1">
                                <img 
                                    src="https://raw.githubusercontent.com/ardradental/Bill/main/logo.png"
                                    alt="Ardra Dental Clinic Logo" 
                                    className="w-24 h-24 object-contain"
                                    onError={(e) => {
                                        e.target.onerror = null;
                                        e.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96"%3E%3Crect width="96" height="96" fill="%237c3aed" rx="8"/%3E%3Ctext x="50%25" y="45%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" font-weight="bold" fill="white"%3EARDRA%3C/text%3E%3Ctext x="50%25" y="65%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="10" fill="white"%3EDENTAL%3C/text%3E%3C/svg%3E';
                                    }}
                                />
                                <div>
                                    <h1 className="text-3xl font-bold text-purple-800 mb-1">ARDRA DENTAL CLINIC</h1>
                                    <p className="text-lg text-purple-600 mb-2 italic">We pride in your radiant smile</p>
                                    <p className="text-gray-600 mb-1 text-sm">www.ardradentalclinics.com</p>
                                    <div className="flex items-center gap-3 text-gray-600 text-sm">
                                        <a href="tel:9059046833" className="flex items-center gap-1 hover:text-purple-600">
                                            <Icon name="phone" className="w-4 h-4" />
                                            <span>9059046833</span>
                                        </a>
                                        <a href="https://wa.me/919059046833" target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 hover:text-green-600">
                                            <Icon name="whatsapp" className="w-4 h-4 text-green-600" />
                                            <span className="text-green-600">WhatsApp</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col items-end text-right">
                                <div className="text-3xl font-bold text-purple-800 mb-3">INVOICE</div>
                                <div className="space-y-2">
                                    <div className="flex items-center justify-end gap-2">
                                        <span className="text-sm font-semibold text-gray-700 min-w-[80px] text-right">Invoice #:</span>
                                        <input
                                            type="text"
                                            value={invoiceNumber}
                                            onChange={(e) => setInvoiceNumber(e.target.value)}
                                            className="w-48 px-3 py-1.5 border-2 border-purple-300 rounded-lg text-sm font-mono bg-purple-50"
                                        />
                                    </div>
                                    <div className="flex items-center justify-end gap-2">
                                        <span className="text-sm font-semibold text-gray-700 min-w-[80px] text-right">Date:</span>
                                        <input
                                            type="date"
                                            value={invoiceDate}
                                            onChange={(e) => setInvoiceDate(e.target.value)}
                                            className="w-48 px-3 py-1.5 border-2 border-purple-300 rounded-lg text-sm bg-purple-50"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-4 mb-3 border border-gray-200">
                        <h2 className="text-xl font-semibold text-purple-800 mb-3">Patient Information</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Patient Name *</label>
                                <input
                                    type="text"
                                    value={patientName}
                                    onChange={(e) => setPatientName(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Enter patient name"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Age *</label>
                                <input
                                    type="number"
                                    value={patientAge}
                                    onChange={(e) => setPatientAge(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Age"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Phone Number</label>
                                <input
                                    type="tel"
                                    value={patientPhone}
                                    onChange={(e) => setPatientPhone(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Phone"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Email Address</label>
                                <input
                                    type="email"
                                    value={patientEmail}
                                    onChange={(e) => setPatientEmail(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Email"
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-1 gap-3 mt-3">
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Patient Location</label>
                                <input
                                    type="text"
                                    value={patientLocation}
                                    onChange={(e) => setPatientLocation(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Location"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Clinical Assessment</label>
                                <textarea
                                    value={clinicalAssessment}
                                    onChange={(e) => setClinicalAssessment(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Enter clinical assessment..."
                                    rows="2"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-4 mb-3 border border-gray-200">
                        <h2 className="text-xl font-semibold text-purple-800 mb-3">Doctor Information</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Treated By Dr. *</label>
                                <select
                                    value={showOtherDoctor ? 'Others' : doctorName}
                                    onChange={(e) => handleDoctorChange(e.target.value)}
                                    className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white text-sm"
                                >
                                    <option value="">-- Select Doctor --</option>
                                    <option value="Mounika Mokkapati">Mounika Mokkapati</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                            {showOtherDoctor && (
                                <>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Other Doctor Name *</label>
                                        <input
                                            type="text"
                                            value={otherDoctorName}
                                            onChange={(e) => setOtherDoctorName(e.target.value)}
                                            className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                            placeholder="Enter doctor name"
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <div className="bg-purple-100 border-2 border-purple-400 rounded-lg p-3">
                                            <p className="text-purple-900 font-semibold text-sm">✓ Under the supervision of Dr. Mounika Mokkapati</p>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-4 mb-3 border border-gray-200">
                        <h2 className="text-xl font-semibold text-purple-800 mb-3">Treatment Details</h2>
                        
                        <div className="grid grid-cols-1 gap-3 mb-3 no-print">
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Select Treatment</label>
                                <select
                                    value={showCustomInput ? 'Custom - Describe Service' : currentTreatment}
                                    onChange={(e) => handleTreatmentSelect(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                >
                                    <option value="">-- Select Treatment --</option>
                                    {commonTreatments.map((treatment, idx) => (
                                        <option key={idx} value={treatment}>{treatment}</option>
                                    ))}
                                </select>
                            </div>

                            {showCustomInput && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Describe Custom Service</label>
                                    <textarea
                                        value={customDescription}
                                        onChange={(e) => setCustomDescription(e.target.value)}
                                        className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                        placeholder="Enter detailed description..."
                                        rows="2"
                                    />
                                </div>
                            )}

                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Treatment Plan</label>
                                <textarea
                                    value={treatmentPlan}
                                    onChange={(e) => setTreatmentPlan(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Treatment plan and follow-up..."
                                    rows="2"
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Price (₹)</label>
                                <input
                                    type="number"
                                    value={currentPrice}
                                    onChange={(e) => setCurrentPrice(e.target.value)}
                                    className="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                    placeholder="Enter price"
                                    onKeyPress={(e) => { if (e.key === 'Enter') addTreatment(); }}
                                />
                            </div>
                        </div>

                        <button
                            onClick={addTreatment}
                            disabled={(!currentTreatment && !customDescription) || !currentPrice}
                            className="w-full md:w-auto px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 mb-3 disabled:bg-gray-400 disabled:cursor-not-allowed no-print font-semibold text-sm"
                        >
                            <Icon name="plus" className="w-4 h-4" />
                            Add Treatment
                        </button>

                        {treatments.length > 0 && (
                            <div className="border-2 border-purple-200 rounded-lg overflow-hidden mb-3">
                                <table className="w-full text-sm">
                                    <thead className="bg-gradient-to-r from-purple-100 to-purple-50">
                                        <tr>
                                            <th className="px-3 py-2 text-left text-xs font-semibold text-purple-900">Treatment/Service</th>
                                            <th className="px-3 py-2 text-left text-xs font-semibold text-purple-900">Treatment Plan</th>
                                            <th className="px-3 py-2 text-right text-xs font-semibold text-purple-900">Price (₹)</th>
                                            <th className="px-3 py-2 text-center text-xs font-semibold text-purple-900 no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-purple-100">
                                        {treatments.map((treatment) => (
                                            <tr key={treatment.id} className="hover:bg-purple-50">
                                                {editingTreatment === treatment.id ? (
                                                    <>
                                                        <td className="px-3 py-2">
                                                            <textarea
                                                                value={editValues.name}
                                                                onChange={(e) => setEditValues({...editValues, name: e.target.value})}
                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                rows="2"
                                                            />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <textarea
                                                                value={editValues.plan}
                                                                onChange={(e) => setEditValues({...editValues, plan: e.target.value})}
                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                rows="2"
                                                            />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <input
                                                                type="number"
                                                                value={editValues.price}
                                                                onChange={(e) => setEditValues({...editValues, price: e.target.value})}
                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs text-right"
                                                            />
                                                        </td>
                                                        <td className="px-3 py-2 text-center no-print">
                                                            <div className="flex items-center justify-center gap-2">
                                                                <button onClick={() => saveEdit(treatment.id)} className="text-green-600 hover:text-green-800">
                                                                    <Icon name="check" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={cancelEdit} className="text-gray-600 hover:text-gray-800">
                                                                    <Icon name="x" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </>
                                                ) : (
                                                    <>
                                                        <td className="px-3 py-2 text-xs text-gray-800 font-medium">{treatment.name}</td>
                                                        <td className="px-3 py-2 text-xs text-gray-600">{treatment.plan || '-'}</td>
                                                        <td className="px-3 py-2 text-xs text-gray-800 text-right font-semibold">₹ {treatment.price.toFixed(2)}</td>
                                                        <td className="px-3 py-2 text-center no-print">
                                                            <div className="flex items-center justify-center gap-2">
                                                                <button onClick={() => startEdit(treatment)} className="text-purple-600 hover:text-purple-800">
                                                                    <Icon name="edit" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => removeTreatment(treatment.id)} className="text-red-600 hover:text-red-800">
                                                                    <Icon name="trash" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {treatments.length > 0 && (
                            <div className="bg-gradient-to-br from-purple-50 via-blue-50 to-cyan-50 rounded-lg p-4 border-2 border-purple-300">
                                <h3 className="text-lg font-semibold text-purple-900 mb-3">Invoice Summary</h3>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center pb-1">
                                        <span className="text-gray-800 font-medium text-sm">Subtotal:</span>
                                        <span className="font-semibold text-base text-gray-900">₹ {calculateSubtotal().toFixed(2)}</span>
                                    </div>
                                    
                                    <div className="flex justify-between items-center border-t border-purple-200 pt-1">
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-800 font-medium text-sm">Discount:</span>
                                            <input
                                                type="number"
                                                value={discount}
                                                onChange={(e) => setDiscount(e.target.value)}
                                                className="w-16 px-2 py-1 border-2 border-purple-300 rounded text-xs bg-white"
                                                min="0"
                                                max="100"
                                            />
                                            <span className="text-xs text-gray-600 font-medium">%</span>
                                        </div>
                                        <span className="font-semibold text-base text-red-600">- ₹ {calculateDiscount().toFixed(2)}</span>
                                    </div>

                                    <div className="flex justify-between items-center pb-1">
                                        <span className="text-gray-700 text-sm">After Discount:</span>
                                        <span className="font-semibold text-sm text-gray-900">₹ {(calculateSubtotal() - calculateDiscount()).toFixed(2)}</span>
                                    </div>

                                    <div className="flex justify-between items-center border-t border-purple-200 pt-1">
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-800 font-medium text-sm">Tax (GST):</span>
                                            <input
                                                type="number"
                                                value={tax}
                                                onChange={(e) => setTax(e.target.value)}
                                                className="w-16 px-2 py-1 border-2 border-purple-300 rounded text-xs bg-white"
                                                min="0"
                                                max="100"
                                            />
                                            <span className="text-xs text-gray-600 font-medium">%</span>
                                        </div>
                                        <span className="font-semibold text-base text-green-600">+ ₹ {calculateTax().toFixed(2)}</span>
                                    </div>

                                    <div className="border-t-4 border-purple-500 pt-2 flex justify-between items-center bg-white rounded-lg p-3 mt-2 shadow-lg">
                                        <span className="text-xl font-bold text-purple-900">Total Amount:</span>
                                        <span className="text-3xl font-bold text-purple-800">₹ {calculateTotal().toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {treatments.length > 0 && (
                        <div className="bg-white rounded-lg shadow-lg p-4 mb-3 border border-gray-200">
                            <h2 className="text-xl font-semibold text-purple-800 mb-3">Payment Information</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Payment Type *</label>
                                    <select
                                        value={paymentType}
                                        onChange={(e) => setPaymentType(e.target.value)}
                                        className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white text-sm"
                                    >
                                        <option value="">-- Select Payment Type --</option>
                                        {paymentTypes.map((type, idx) => (
                                            <option key={idx} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                {paymentType === 'Custom (Multiple Modes)' && (
                                    <>
                                        <div className="md:col-span-2 bg-blue-50 rounded-lg p-3 border-2 border-blue-300">
                                            <h4 className="font-semibold text-purple-800 mb-2 text-sm">Payment Mode 1</h4>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Mode</label>
                                                    <select
                                                        value={customPayment.mode1}
                                                        onChange={(e) => setCustomPayment({...customPayment, mode1: e.target.value})}
                                                        className="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                                    >
                                                        {paymentModes.map((mode, idx) => (
                                                            <option key={idx} value={mode}>{mode}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Amount (₹)</label>
                                                    <input
                                                        type="number"
                                                        value={customPayment.amount1}
                                                        onChange={(e) => setCustomPayment({...customPayment, amount1: e.target.value})}
                                                        className="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                                        placeholder="0.00"
                                                    />
                                                </div>
                                            </div>

                                            <h4 className="font-semibold text-purple-800 mb-2 mt-3 text-sm">Payment Mode 2</h4>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Mode</label>
                                                    <select
                                                        value={customPayment.mode2}
                                                        onChange={(e) => setCustomPayment({...customPayment, mode2: e.target.value})}
                                                        className="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                                    >
                                                        {paymentModes.map((mode, idx) => (
                                                            <option key={idx} value={mode}>{mode}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Amount (₹)</label>
                                                    <input
                                                        type="number"
                                                        value={customPayment.amount2}
                                                        onChange={(e) => setCustomPayment({...customPayment, amount2: e.target.value})}
                                                        className="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                                                        placeholder="0.00"
                                                    />
                                                </div>
                                            </div>

                                            {customPayment.amount1 && customPayment.amount2 && (
                                                <div className="mt-3 bg-white rounded-lg p-2 border-2 border-purple-400">
                                                    <div className="flex justify-between text-sm">
                                                        <span className="font-medium">{customPayment.mode1}:</span>
                                                        <span className="font-bold">₹ {parseFloat(customPayment.amount1 || 0).toFixed(2)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="font-medium">{customPayment.mode2}:</span>
                                                        <span className="font-bold">₹ {parseFloat(customPayment.amount2 || 0).toFixed(2)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm border-t-2 border-purple-300 mt-1 pt-1">
                                                        <span className="font-bold">Total Paid:</span>
                                                        <span className="font-bold text-purple-800">₹ {(parseFloat(customPayment.amount1 || 0) + parseFloat(customPayment.amount2 || 0)).toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}

                                {paymentType === 'EMI (Through SaveIn)' && (
                                    <>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Down Payment (₹) *</label>
                                            <input
                                                type="number"
                                                value={downPayment}
                                                onChange={(e) => setDownPayment(e.target.value)}
                                                className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                                placeholder="Enter down payment"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">EMI Months *</label>
                                            <input
                                                type="number"
                                                value={emiMonths}
                                                onChange={(e) => setEmiMonths(e.target.value)}
                                                className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                                placeholder="Number of months"
                                                min="1"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Processing Fee (₹)</label>
                                            <input
                                                type="number"
                                                value={processingFee}
                                                onChange={(e) => setProcessingFee(e.target.value)}
                                                className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                                placeholder="SaveIn fee"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">Transaction ID</label>
                                            <input
                                                type="text"
                                                value={emiTransactionId}
                                                onChange={(e) => setEmiTransactionId(e.target.value)}
                                                className="w-full px-3 py-1.5 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                                placeholder="SaveIn ID"
                                            />
                                        </div>
                                        {emiMonths && downPayment && (
                                            <div className="md:col-span-2">
                                                <div className="bg-purple-100 border-2 border-purple-400 rounded-lg p-3">
                                                    <h3 className="text-sm font-semibold text-purple-900 mb-2">EMI Calculation (SaveIn)</h3>
                                                    <div className="space-y-1 text-xs">
                                                        <div className="flex justify-between">
                                                            <span className="font-medium">Total Invoice:</span>
                                                            <span className="font-bold">₹ {calculateTotal().toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="font-medium">Down Payment:</span>
                                                            <span className="font-bold text-green-600">- ₹ {parseFloat(downPayment).toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="font-medium">Processing Fee:</span>
                                                            <span className="font-bold text-orange-600">+ ₹ {parseFloat(processingFee || 0).toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between border-t border-purple-300 pt-1">
                                                            <span className="font-medium">Amount Financed:</span>
                                                            <span className="font-bold">₹ {(calculateTotal() - parseFloat(downPayment) + parseFloat(processingFee || 0)).toFixed(2)}</span>
                                                        </div>
                                                        <div className="bg-purple-200 p-2 rounded mt-1">
                                                            <div className="flex justify-between items-center">
                                                                <span className="font-bold">EMI/Month ({emiMonths}m):</span>
                                                                <span className="font-bold text-purple-900 text-base">₹ {calculateEMIAmount().toFixed(2)}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}

                                {paymentType && paymentType !== 'EMI (Through SaveIn)' && paymentType !== 'Custom (Multiple Modes)' && (
                                    <div className="md:col-span-2">
                                        <div className="bg-green-100 border-2 border-green-400 rounded-lg p-3">
                                            <p className="text-green-800 font-semibold text-sm">✓ Payment Type: {paymentType}</p>
                                            <p className="text-green-700 mt-1 text-sm">Amount Paid: ₹ {calculateTotal().toFixed(2)}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {(doctorName || otherDoctorName) && treatments.length > 0 && paymentType && (
                        <div className="bg-white rounded-lg shadow-lg p-4 mb-3 border border-gray-200">
                            <div className="flex justify-between items-center">
                                <div className="text-left">
                                    <p className="text-gray-700 text-xs mb-1 font-medium">Authorized Signature</p>
                                    <p className="font-bold text-purple-800 text-2xl italic mb-2" style={{fontFamily: 'cursive'}}>
                                        Ardra Dental Clinic
                                    </p>
                                    <div className="mt-2 pt-1 border-t border-gray-300">
                                        <p className="text-xs text-gray-500">Computer generated invoice</p>
                                    </div>
                                </div>
                                <div className="relative">
                                    <div className="text-5xl font-bold text-green-500 opacity-30 transform -rotate-12 border-4 border-green-500 px-6 py-3 rounded-lg shadow-lg">
                                        PAID
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 no-print mb-3">
                        <button
                            onClick={handlePrint}
                            disabled={!patientName || !patientAge || (showOtherDoctor ? !otherDoctorName : !doctorName) || treatments.length === 0 || !paymentType}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold shadow-lg text-sm"
                        >
                            <Icon name="printer" className="w-4 h-4" />
                            Print
                        </button>
                        
                        <button
                            onClick={clearForm}
                            className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold shadow-lg text-sm"
                        >
                            Clear All
                        </button>
                    </div>

                    <div className="mt-4 pt-3 border-t-2 border-purple-300 text-center text-xs text-gray-700">
                        <p className="font-bold text-base text-purple-800 mb-2">Thank you for choosing ARDRA DENTAL CLINIC</p>
                        <p className="text-xs leading-relaxed mb-1 font-medium">Metro Pillar No:A835, Opp Ashoka One Mall, 2nd Floor<br />Kukatpally, Hyderabad, Telangana 500072</p>
                        <p className="font-medium text-xs">www.ardradentalclinics.com | ardradentalclinic@gmail.com</p>
                        <p className="mt-1 font-medium text-xs">Contact: 9059046833, 9032376833</p>
                        <p className="mt-2 text-purple-600 italic text-sm">We pride in your radiant smile</p>
                    </div>
                </div>
            </div>
        </div>
    );
}
